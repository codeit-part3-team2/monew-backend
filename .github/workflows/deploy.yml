name: CD - Deploy to ECS

on:
  push:
    branches:
      - release
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: monew-cluster

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: api
            dockerfile: Dockerfile.api
            ecr_repo: monew-api
            ecs_service: monew-api-service
            task_definition: monew-api-task
          - name: batch
            dockerfile: Dockerfile.batch
            ecr_repo: monew-batch
            ecs_service: monew-batch-service
            task_definition: monew-batch-task
          - name: monitor
            dockerfile: Dockerfile.monitor
            ecr_repo: monew-monitor
            ecs_service: monew-monitor-service
            task_definition: monew-monitor-task
          - name: prometheus
            dockerfile: Dockerfile.prom
            ecr_repo: monew-prometheus
            ecs_service: monew-prometheus-service
            task_definition: monew-prometheus-task
          - name: grafana
            dockerfile: Dockerfile.grafana
            ecr_repo: monew-grafana
            ecs_service: monew-grafana-service
            task_definition: monew-grafana-task

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ========================================
      # ECR ë¡œê·¸ì¸ (Public ë˜ëŠ” Private)
      # ========================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ========================================
      # Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      # ========================================
      - name: Build, tag, and push ${{ matrix.service.name }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            -f ${{ matrix.service.dockerfile }} \
            -t $ECR_REGISTRY/${{ matrix.service.ecr_repo }}:$IMAGE_TAG \
            -t $ECR_REGISTRY/${{ matrix.service.ecr_repo }}:latest \
            .
          
          docker push $ECR_REGISTRY/${{ matrix.service.ecr_repo }}:$IMAGE_TAG
          docker push $ECR_REGISTRY/${{ matrix.service.ecr_repo }}:latest

  # ========================================
  # ECS ë°°í¬ - API & ëª¨ë‹ˆí„°ë§ (ë³‘ë ¬)
  # ========================================
  deploy-main:
    runs-on: ubuntu-latest
    needs: build-and-push
    strategy:
      matrix:
        service:
          - name: api
            ecs_service: monew-api-service
            task_definition: monew-api-task
            ecr_repo: monew-api
          - name: monitor
            ecs_service: monew-monitor-service
            task_definition: monew-monitor-task
            ecr_repo: monew-monitor
          - name: prometheus
            ecs_service: monew-prometheus-service
            task_definition: monew-prometheus-task
            ecr_repo: monew-prometheus
          - name: grafana
            ecs_service: monew-grafana-service
            task_definition: monew-grafana-task
            ecr_repo: monew-grafana

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ========================================
      # íƒœìŠ¤í¬ ì •ì˜ ì—…ë°ì´íŠ¸
      # ========================================
      - name: Update task definition
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # í˜„ì¬ íƒœìŠ¤í¬ ì •ì˜ ê°€ì ¸ì˜¤ê¸°
          TASK_DEFINITION=$(aws ecs describe-task-definition \
            --task-definition ${{ matrix.service.task_definition }} \
            --query 'taskDefinition' \
            --output json)

          # ìƒˆ ì´ë¯¸ì§€ë¡œ ì—…ë°ì´íŠ¸
          NEW_TASK_DEFINITION=$(echo $TASK_DEFINITION | jq \
            --arg IMAGE "$ECR_REGISTRY/${{ matrix.service.ecr_repo }}:$IMAGE_TAG" \
            '.containerDefinitions[0].image = $IMAGE | 
             del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          # ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
          NEW_TASK_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEFINITION" | \
            jq -r '.taskDefinition.taskDefinitionArn')

          echo "NEW_TASK_ARN=$NEW_TASK_ARN" >> $GITHUB_ENV

      # ========================================
      # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      # ========================================
      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ matrix.service.ecs_service }} \
            --task-definition ${{ env.NEW_TASK_ARN }} \
            --desired-count 1 \
            --force-new-deployment

          echo "âœ… ${{ matrix.service.name }} service deployed!"

      # ========================================
      # ë°°í¬ ìƒíƒœ í™•ì¸ (ì„ íƒì‚¬í•­)
      # ========================================
      - name: Wait for service stability
        run: |
          echo "Waiting for service to be stable..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ matrix.service.ecs_service }}
          
          echo "ğŸš€ ${{ matrix.service.name }} deployment completed!"

  # ========================================
  # ECS ë°°í¬ - Batch (API ì•ˆì •í™” í›„)
  # ========================================
  deploy-batch:
    runs-on: ubuntu-latest
    needs: deploy-main  # â­ API ë°°í¬ ì™„ë£Œ í›„ ì‹¤í–‰
    strategy:
      matrix:
        service:
          - name: batch
            ecs_service: monew-batch-service
            task_definition: monew-batch-task
            ecr_repo: monew-batch

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ========================================
      # íƒœìŠ¤í¬ ì •ì˜ ì—…ë°ì´íŠ¸
      # ========================================
      - name: Update task definition
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # í˜„ì¬ íƒœìŠ¤í¬ ì •ì˜ ê°€ì ¸ì˜¤ê¸°
          TASK_DEFINITION=$(aws ecs describe-task-definition \
            --task-definition ${{ matrix.service.task_definition }} \
            --query 'taskDefinition' \
            --output json)

          # ìƒˆ ì´ë¯¸ì§€ë¡œ ì—…ë°ì´íŠ¸
          NEW_TASK_DEFINITION=$(echo $TASK_DEFINITION | jq \
            --arg IMAGE "$ECR_REGISTRY/${{ matrix.service.ecr_repo }}:$IMAGE_TAG" \
            '.containerDefinitions[0].image = $IMAGE | 
             del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          # ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
          NEW_TASK_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEFINITION" | \
            jq -r '.taskDefinition.taskDefinitionArn')

          echo "NEW_TASK_ARN=$NEW_TASK_ARN" >> $GITHUB_ENV

      # ========================================
      # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      # ========================================
      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ matrix.service.ecs_service }} \
            --task-definition ${{ env.NEW_TASK_ARN }} \
            --desired-count 1 \
            --force-new-deployment

          echo "âœ… ${{ matrix.service.name }} service deployed!"

      # ========================================
      # ë°°í¬ ìƒíƒœ í™•ì¸ (ì„ íƒì‚¬í•­)
      # ========================================
      - name: Wait for service stability
        run: |
          echo "Waiting for service to be stable..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ matrix.service.ecs_service }}
          
          echo "ğŸš€ ${{ matrix.service.name }} deployment completed!"